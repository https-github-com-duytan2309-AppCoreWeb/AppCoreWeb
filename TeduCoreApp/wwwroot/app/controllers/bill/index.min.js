var BillController=function(){function e(){$("#txtFromDate, #txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"});$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtCustomerName:{required:!0},txtCustomerAddress:{required:!0},txtCustomerMobile:{required:!0},txtCustomerMessage:{required:!0},ddlBillStatus:{required:!0}}});$("#txt-search-keyword").keypress(function(n){n.which===13&&(n.preventDefault(),t())});$("#btn-search").on("click",function(){t()});$("#btn-create").on("click",function(){i();$("#modal-detail").modal("show")});$("#ddl-show-page").on("change",function(){tedu.configs.pageSize=$(this).val();tedu.configs.pageIndex=1;t(!0)});$("body").on("click",".btn-view",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/Admin/Bill/GetById",data:{id:t},beforeSend:function(){tedu.startLoading()},success:function(n){var t=n,e,i,o;$("#hidId").val(t.Id);$("#txtCustomerName").val(t.CustomerName);$("#txtCustomerAddress").val(t.CustomerAddress);$("#txtCustomerMobile").val(t.CustomerMobile);$("#txtCustomerMessage").val(t.CustomerMessage);$("#ddlPaymentMethod").val(t.PaymentMethod);$("#ddlCustomerId").val(t.CustomerId);$("#ddlBillStatus").val(t.BillStatus);e=t.BillDetails;t.BillDetails!==null&&t.BillDetails.length>0&&(i="",o=$("#template-table-bill-details").html(),$.each(e,function(n,t){var e=r(t.ProductId),s=u(t.ColorId),h=f(t.SizeId);i+=Mustache.render(o,{Id:t.Id,Products:e,Colors:s,Sizes:h,Quantity:t.Quantity})}),$("#tbl-bill-details").html(i));$("#modal-detail").modal("show");tedu.stopLoading()},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}})});$("body").on("click",".btn-view-client",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/BillDetails/GetById",data:{id:t},beforeSend:function(){tedu.startLoading()},success:function(n){var t=n,i,u,r,f;$("#hidId").val(t.Id);$("#txtCustomerName").val(t.CustomerName);$("#txtCustomerAddress").val(t.CustomerAddress);$("#txtCustomerMobile").val(t.CustomerMobile);$("#txtCustomerMessage").val(t.CustomerMessage);$("#ddlPaymentMethod").val(t.PaymentMethod);$("#ddlCustomerId").val(t.CustomerId);$("#ddlBillStatus").val(t.BillStatus);i="";t.Status===0?(i+="<h3>Đơn Hàng Đang Được Xét Duyệt<\/h3>",$("#txtStatus").html(i)):(i+="<h3>Đơn Hàng Đã Được Chốt<\/h3>",$("#txtStatus").html(i));u=t.BillDetails;t.BillDetails!==null&&t.BillDetails.length>0&&(r="",f=$("#template-table-bill-details").html(),$.each(u,function(n,i){var e=v(i.ProductId),o=y(i.ColorId,t.Status),s=p(i.SizeId,t.Status),h=a(i.ProductId),u="";u+=t.Status===0?'<input type="number" class="txtQuantity" value="'+i.Quantity+'" />':'<input type="number" class="txtQuantity" value="'+i.Quantity+'" disabled />';r+=Mustache.render(f,{Id:i.Id,Products:e,Images:h,Colors:o,Sizes:s,Quantity:u})}),$("#tbl-bill-details").html(r));$("#modal-detail").modal("show");tedu.stopLoading()},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}})});$("#btnSave").on("click",function(n){if($("#frmMaintainance").valid()){n.preventDefault();var r=$("#hidId").val(),f=$("#txtCustomerName").val(),e=$("#txtCustomerAddress").val(),o=$("#ddlCustomerId").val(),s=$("#txtCustomerMobile").val(),h=$("#txtCustomerMessage").val(),c=$("#ddlPaymentMethod").val(),l=$("#ddlBillStatus").val(),u=[];return $.each($("#tbl-bill-details tr"),function(n,t){u.push({Id:$(t).data("id"),ProductId:$(t).find("select.ddlProductId").first().val(),Quantity:$(t).find("input.txtQuantity").first().val(),ColorId:$(t).find("select.ddlColorId").first().val(),SizeId:$(t).find("select.ddlSizeId").first().val(),BillId:r})}),$.ajax({type:"POST",url:"/Admin/Bill/SaveEntity",data:{Id:r,BillStatus:l,CustomerAddress:e,CustomerId:o,CustomerMessage:h,CustomerMobile:s,CustomerName:f,PaymentMethod:c,Status:1,BillDetails:u},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(){tedu.notify("Save order successful","success");$("#modal-detail").modal("hide");i();tedu.stopLoading();t(!0)},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}}),!1}});$("#btnSaveClient").on("click",function(n){if($("#frmMaintainance").valid()){n.preventDefault();var r=$("#hidId").val(),f=$("#txtCustomerName").val(),e=$("#txtCustomerAddress").val(),o=$("#ddlCustomerId").val(),s=$("#txtCustomerMobile").val(),h=$("#txtCustomerMessage").val(),c=$("#ddlPaymentMethod").val(),l=$("#ddlBillStatus").val(),u=[];return $.each($("#tbl-bill-details tr"),function(n,t){u.push({Id:$(t).data("id"),ProductId:$(t).find("select.ddlProductId").first().val(),Quantity:$(t).find("input.txtQuantity").first().val(),ColorId:$(t).find("select.ddlColorId").first().val(),SizeId:$(t).find("select.ddlSizeId").first().val(),BillId:r})}),$.ajax({type:"POST",url:"/Admin/Bill/SaveEntity",data:{Id:r,BillStatus:l,CustomerAddress:e,CustomerId:o,CustomerMessage:h,CustomerMobile:s,CustomerName:f,PaymentMethod:c,Status:1,BillDetails:u},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(){tedu.notify("Save order successful","success");$("#modal-detail").modal("hide");i();tedu.stopLoading();t(!0)},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}}),!1}});$("#btnAddDetail").on("click",function(){var n=$("#template-table-bill-details").html(),t=r(null),i=u(null),e=f(null),o=Mustache.render(n,{Id:0,Products:t,Colors:i,Sizes:e,Quantity:0,Total:0});$("#tbl-bill-details").append(o)});$("body").on("click",".btn-delete-detail",function(){$(this).parent().parent().remove()});$("#btnExport").on("click",function(){var n=$("#hidId").val();$.ajax({type:"POST",url:"/Admin/Bill/ExportExcel",data:{billId:n},beforeSend:function(){tedu.startLoading()},success:function(n){window.location.href=n;tedu.stopLoading()}})})}function o(){return $.ajax({type:"GET",url:"/admin/bill/GetBillStatus",dataType:"json",success:function(t){n.billStatuses=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlBillStatus").html(i)}})}function s(){return $.ajax({type:"GET",url:"/admin/bill/GetPaymentMethod",dataType:"json",success:function(t){n.paymentMethods=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlPaymentMethod").html(i)}})}function h(){return $.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(t){n.products=t},error:function(){tedu.notify("Has an error in progress","error")}})}function c(){return $.ajax({type:"GET",url:"/Admin/Bill/GetColors",dataType:"json",success:function(t){n.colors=t},error:function(){tedu.notify("Has an error in progress","error")}})}function l(){return $.ajax({type:"GET",url:"/Admin/Bill/GetSizes",dataType:"json",success:function(t){n.sizes=t},error:function(){tedu.notify("Has an error in progress","error")}})}function a(t){var i="";return $.each(n.products,function(n,r){t===r.Id&&(i+='<img style="width: 60px; height: 30px" src="'+r.Image+'" />')}),i}function r(t){var i="<select class='form-control ddlProductId'>";return $.each(n.products,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function v(t){var i="<select style='width: 150px' class='form-control ddlProductId' disabled>";return $.each(n.products,function(n,r){t===r.Id&&(i+='<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>")}),i}function u(t){var i="<select class='form-control ddlColorId'>";return $.each(n.colors,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function y(t,i){var r="";return r=i===0?"<select style='width: 150px'  class='form-control ddlColorId'>":"<select style='width: 150px'  class='form-control ddlColorId' disabled>",$.each(n.colors,function(n,i){r+=t===i.Id?'<option style="width: 100px;" value="'+i.Id+'" selected="select">'+i.Name+"<\/option>":'<option style="width: 100px;" value="'+i.Id+'">'+i.Name+"<\/option>"}),r+="<\/select>"}function f(t){var i="<select class='form-control ddlSizeId'>";return $.each(n.sizes,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function p(t,i){var r="";return r=i===0?"<select style='width: 180px' class='form-control ddlSizeId'>":"<select style='width: 180px' class='form-control ddlSizeId' disabled>",$.each(n.sizes,function(n,i){r+=t===i.Id?'<option  value="'+i.Id+'" selected="select">'+i.Name+"<\/option>":'<option  value="'+i.Id+'">'+i.Name+"<\/option>"}),r+="<\/select>"}function i(){$("#hidId").val(0);$("#txtCustomerName").val("");$("#txtCustomerAddress").val("");$("#txtCustomerMobile").val("");$("#txtCustomerMessage").val("");$("#ddlPaymentMethod").val("");$("#ddlCustomerId").val("");$("#ddlBillStatus").val("");$("#tbl-bill-details").html("")}function t(n){$.ajax({type:"GET",url:"/admin/bill/GetAllPaging",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txtSearchKeyword").val(),page:tedu.configs.pageIndex,pageSize:tedu.configs.pageSize},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(i){var u=$("#table-template").html(),r="";i.RowCount>0?($.each(i.Results,function(n,t){r+=Mustache.render(u,{CustomerName:t.CustomerName,CustomerAddress:t.CustomerAddress,CustomerPhoneNumber:t.CustomerMobile,CustomerMessage:t.CustomerMessage,Id:t.Id,PaymentMethod:w(t.PaymentMethod),DateCreated:tedu.dateTimeFormatJson(t.DateCreated),BillStatus:b(t.BillStatus)})}),$("#lbl-total-records").text(i.RowCount),r!==undefined&&$("#tbl-content").html(r),k(i.RowCount,function(){t()},n)):($("#lbl-total-records").text("0"),$("#tbl-content").html(""));tedu.stopLoading()},error:function(n){console.log(n)}})}function w(t){var i=$.grep(n.paymentMethods,function(n){return n.Value===t});return i.length>0?i[0].Name:""}function b(t){return t=$.grep(n.billStatuses,function(n){return n.Value===t}),t.length>0?t[0].Name:""}function k(n,t,i){var r=Math.ceil(n/tedu.configs.pageSize);($("#paginationUL a").length===0||i===!0)&&($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:r,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(n,i){tedu.configs.pageIndex=i;setTimeout(t(),200)}})}var n={products:[],colors:[],sizes:[],paymentMethods:[],billStatuses:[]};this.initialize=function(){$.when(o(),h(),s(),c(),l()).done(function(){t()});e()}};