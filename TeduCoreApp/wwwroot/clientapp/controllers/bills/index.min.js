var BillController=function(){var t={products:[],colors:[],sizes:[],paymentMethods:[],billStatuses:[],images:[]};function e(e){var a="<div ";return $.each(t.products,function(t,o){e===o.Id&&(a+='type="text" value="'+o.Id+'" disabled >'+o.Name+"</div>")}),a}function a(e,a){var o="";return o=0===a?"<select style='width: 150px'  class='form-control ddlColorId'>":"<select style='width: 150px'  class='form-control ddlColorId' disabled>",$.each(t.colors,function(t,a){e===a.Id?o+='<option style="width: 100px;" value="'+a.Id+'" selected="select">'+a.Name+"</option>":o+='<option style="width: 100px;" value="'+a.Id+'">'+a.Name+"</option>"}),o+="</select>"}function o(e,a){var o="";return o=0===a?"<select style='width: 180px' class='form-control ddlSizeId'>":"<select style='width: 180px' class='form-control ddlSizeId' disabled>",$.each(t.sizes,function(t,a){e===a.Id?o+='<option  value="'+a.Id+'" selected="select">'+a.Name+"</option>":o+='<option  value="'+a.Id+'">'+a.Name+"</option>"}),o+="</select>"}function l(){$("#hidId").val(0),$("#txtCustomerName").val(""),$("#txtCustomerAddress").val(""),$("#txtCustomerMobile").val(""),$("#txtCustomerMessage").val(""),$("#ddlPaymentMethod").val(""),$("#ddlCustomerId").val(""),$("#ddlBillStatus").val(""),$("#tbl-bill-details").html("")}function n(t){$.ajax({type:"GET",url:"/BillDetails/GetAllPaging",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txtSearchKeyword").val(),page:tedu.configs.pageIndex,pageSize:tedu.configs.pageSize},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(e){var a=$("#table-template").html(),o="";e.RowCount>0?($.each(e.Results,function(t,e){var l=new Date(e.DateCreated);o+=Mustache.render(a,{CustomerName:e.CustomerName,CustomerAddress:e.CustomerAddress,CustomerPhoneNumber:e.CustomerMobile,CustomerMessage:e.CustomerMessage,Id:e.Id,PaymentMethod:s(e.PaymentMethod),DateCreated:l,BillStatus:i(e.BillStatus)})}),$("#lbl-total-records").text(e.RowCount),void 0!==o&&$("#tbl-content").html(o),function(t,e,a){var o=Math.ceil(t/tedu.configs.pageSize);0!==$("#paginationUL a").length&&!0!==a||($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:o,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(t,a){tedu.configs.pageIndex=a,setTimeout(e(),200)}})}(e.RowCount,function(){n()},t)):($("#lbl-total-records").text("0"),$("#tbl-content").html("")),tedu.stopLoading()},error:function(t){console.log(t)}})}function s(e){var a=$.grep(t.paymentMethods,function(t,a){return t.Value===e});return a.length>0?a[0].Name:""}function i(e){return(e=$.grep(t.billStatuses,function(t,a){return t.Value===e})).length>0?e[0].Name:""}this.initialize=function(){$.when($.ajax({type:"GET",url:"/admin/bill/GetBillStatus",dataType:"json",success:function(e){t.billStatuses=e;var a="";$.each(e,function(t,e){a+="<option value='"+e.Value+"'>"+e.Name+"</option>"}),$("#ddlBillStatus").html(a)}}),$.ajax({type:"GET",url:"/admin/bill/GetPaymentMethod",dataType:"json",success:function(e){t.paymentMethods=e;var a="";$.each(e,function(t,e){a+="<option value='"+e.Value+"'>"+e.Name+"</option>"}),$("#ddlPaymentMethod").html(a)}}),$.ajax({type:"GET",url:"/BillDetails/GetColors",dataType:"json",success:function(e){t.colors=e},error:function(){tedu.notify("Has an error in progress","error")}}),$.ajax({type:"GET",url:"/BillDetails/GetSizes",dataType:"json",success:function(e){t.sizes=e},error:function(){tedu.notify("Has an error in progress","error")}}),$.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(e){t.products=e},error:function(){tedu.notify("Has an error in progress","error")}})).done(function(){n()}),$("#txtFromDate, #txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"}),$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtCustomerName:{required:!0},txtCustomerAddress:{required:!0},txtCustomerMobile:{required:!0},txtCustomerMessage:{required:!0},ddlBillStatus:{required:!0}}}),$("#txt-search-keyword").keypress(function(t){13===t.which&&(t.preventDefault(),n())}),$("#btn-search").on("click",function(){n()}),$("#btn-create").on("click",function(){l(),$("#modal-detail").modal("show")}),$("#ddl-show-page").on("change",function(){tedu.configs.pageSize=$(this).val(),tedu.configs.pageIndex=1,n(!0)}),$("body").on("click",".btn-view",function(l){l.preventDefault();var n=$(this).data("id");$.ajax({type:"GET",url:"/BillDetails/GetById",data:{id:n},beforeSend:function(){tedu.startLoading()},success:function(l){var n=l;$("#hidId").val(n.Id),$("#txtCustomerName").val(n.CustomerName),$("#txtCustomerAddress").val(n.CustomerAddress),$("#txtCustomerMobile").val(n.CustomerMobile),$("#txtCustomerMessage").val(n.CustomerMessage),$("#ddlPaymentMethod").val(n.PaymentMethod),$("#ddlCustomerId").val(n.CustomerId),$("#ddlBillStatus").val(n.BillStatus);var s="";0===n.Status?(s+="<h3>Đơn Hàng Đang Được Xét Duyệt</h3>",$("#txtStatus").html(s)):(s+="<h3>Đơn Hàng Đã Được Chốt</h3>",$("#txtStatus").html(s));var i=n.BillDetails;if(null!==n.BillDetails&&n.BillDetails.length>0){var r="",d=$("#template-table-bill-details").html();$.each(i,function(l,s){var i=e(s.ProductId),u=a(s.ColorId,n.Status),c=o(s.SizeId,n.Status),m=function(e){var a="";return $.each(t.products,function(t,o){e===o.Id&&(a+='<img style="width: 60px; height: 30px" src="'+o.Image+'" />')}),a}(s.ProductId),p="";0===n.Status?p+='<input type="number" class="txtQuantity" value="'+s.Quantity+'" />':p+='<input type="number" class="txtQuantity" value="'+s.Quantity+'" disabled />',r+=Mustache.render(d,{Id:s.Id,Products:i,Images:m,Colors:u,Sizes:c,Quantity:p,Status:n.BillStatus})}),$("#tbl-bill-details").html(r)}$("#modal-detail").modal("show"),tedu.stopLoading()},error:function(t){tedu.notify("Has an error in progress","error"),tedu.stopLoading()}})}),$("#btnSave").on("click",function(t){if($("#frmMaintainance").valid()){t.preventDefault();var e=$("#hidId").val(),a=$("#txtCustomerName").val(),o=$("#txtCustomerAddress").val(),s=$("#ddlCustomerId").val(),i=$("#txtCustomerMobile").val(),r=$("#txtCustomerMessage").val(),d=[];return $.each($("#tbl-bill-details tr"),function(t,a){d.push({Id:$(a).data("id"),ProductId:$(a).find("select.ddlProductId").first().val(),Quantity:$(a).find("input.txtQuantity").first().val(),ColorId:$(a).find("select.ddlColorId").first().val(),SizeId:$(a).find("select.ddlSizeId").first().val(),BillId:e})}),$.ajax({type:"POST",url:"/BillDetails/SaveEntity",data:{Id:e,BillStatus:billStatus,CustomerAddress:o,CustomerId:s,CustomerMessage:r,CustomerMobile:i,CustomerName:a,PaymentMethod:paymentMethod,Status:1,BillDetails:d},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(t){tedu.notify("Save order successfully","success"),$("#modal-detail").modal("hide"),l(),tedu.stopLoading(),n(!0)},error:function(){tedu.notify("Không Lưu Được","error"),tedu.stopLoading()}}),!1}}),$("#btnAddDetail").on("click",function(){var t=$("#template-table-bill-details").html(),l=e(null),n=a(null),s=o(null),i=Mustache.render(t,{Id:0,Products:l,Colors:n,Sizes:s,Quantity:0,Total:0});$("#tbl-bill-details").append(i)}),$("body").on("click",".btn-delete-detail",function(){$(this).parent().parent().remove()}),$("#btnExport").on("click",function(){var t=$("#hidId").val();$.ajax({type:"POST",url:"/BillDetails/ExportExcel",data:{billId:t},beforeSend:function(){tedu.startLoading()},success:function(t){window.location.href=t,tedu.stopLoading()}})})}};